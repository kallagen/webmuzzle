@using TSensor.Web.ViewComponents;
@using TSensor.Web.ViewModels.Point;
@model IEnumerable<TSensor.Web.Models.Entity.PointGroup>
@{
    Layout = null;
}
@if (Model?.Any() == true)
{
    if (Model.Any(p => p.PointGroupGuid == PointGroupMenu.NotAssignedSensorGroupGuid))
    {
        <li>@Html.ActionLink("Датчики без привязки", "NotAssigned", "Point")</li>
    }
    <li class="apply-button hidden"><a href="javascript:void(0)">ПРИМЕНИТЬ</a></li>
    <li><a><input type="checkbox" data-parent="" data-guid="all" class="menu-checkbox" />Все объекты</a></li>
    foreach (var group in Model.Where(p => p.PointGroupGuid != PointGroupMenu.NotAssignedSensorGroupGuid)
        .OrderBy(p => string.IsNullOrEmpty(p.Name)).ThenBy(p => p.Name))
    {
        if (string.IsNullOrEmpty(group.Name))
        {
            foreach (var point in group.PointList.OrderBy(p => p.Name))
            {
                @Html.Partial("MenuElementPoint", new MenuElementViewModel { Point = point });
            }
        }
        else
        {
            @if (group.PointList.Any())
            {
                <li class="treeview">
                    <a href="javascript:void(0)">
                        <input type="checkbox" data-parent="all" data-guid="@group.PointGroupGuid" class="menu-checkbox" /><span>@group.Name</span>
                        <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                    </a>
                    <ul class="treeview-menu">
                        @foreach (var point in group.PointList.OrderBy(p => p.Name))
                        {
                            @Html.Partial("MenuElementPoint", new MenuElementViewModel { Point = point, GroupGuid = group.PointGroupGuid });
                        }
                    </ul>
                </li>
            }
            else
            {
                <li><a><input data-parent="all" data-guid="@group.PointGroupGuid" type="checkbox" class="menu-checkbox" />@group.Name</a></li>
            }
        }
    }
}
<script>
    var MainMenu = function () {
        var that = this;

        that.checkboxes = $('.menu-checkbox');
        that.ignoreCallbackGuid = null;

        that.applyButton = $('.apply-button');
        that.showApplyButton = function () {
            that.applyButton.removeClass('hidden');
        }

        that.checkParent = function (state, guid, parent) {
            var el = $('input[data-guid="' + parent + '"]');
            if (el.length !== 0) {
                if (state === 'checked' && !el.is(':checked') &&
                    $('input[data-parent="' + parent + '"][data-guid!="' + guid + '"]:not(:checked)').length === 0) {
                    el.iCheck('check');
                }
                if (state === 'unchecked' && el.is(':checked')) {
                    that.ignoreCallbackGuid = parent;
                    el.iCheck('uncheck');
                }
            }
        }

        that.eventCallback = {
            checked: function () {
                var el = $(this);
                var parent = el.data('parent');
                var guid = el.data('guid');

                $('input:not(:checked)[data-parent="' + guid + '"]').iCheck('check');
                checkParent('checked', guid, parent);

                that.showApplyButton();
            },
            unchecked: function () {
                var el = $(this);
                var parent = el.data('parent');
                var guid = el.data('guid');

                if (that.ignoreCallbackGuid === guid) {
                    that.ignoreCallbackGuid = null;
                } else {
                    $('input:checked[data-parent="' + guid + '"]').iCheck('uncheck');
                }

                checkParent('unchecked', guid, parent);

                that.showApplyButton();
            }
        }

        that.init = function () {
            that.checkboxes.on('ifChecked', that.eventCallback.checked);
            that.checkboxes.on('ifUnchecked', that.eventCallback.unchecked);

            that.checkboxes.iCheck({
                checkboxClass: 'icheckbox_square-blue'
            });
        };

        that.init();

        return that;
    }();
</script>