@model IEnumerable<ActualSensorValue>
@{
    var pointName = Model.First().PointName;
    ViewBag.Title = pointName;

    var hasError = Model.Any(p => p.IsError);
    var hasWarning = Model.Any(p => p.IsWarning);
}

@section AdditionalHeader
{
    @Html.ActionLink("назад к всем объектам", "All", "Point", null, new { @class = "footer-link pull-right additional-header-link" })
}

@if (hasError)
{
    <div class="callout callout-danger">
        <h4>Внимание!</h4>
        <p>Данные с некоторых датчиков никогда не поступали. Проверьте правильность настроек.</p>
    </div>
}
@if (hasWarning)
{
    <div class="callout callout-warning">
        <h4>Внимание!</h4>
        <p>Данные с некоторых датчиков не поступают больше часа. Проверьте правильность настроек и исправность системы.</p>
    </div>
}

@if (Model.Any(p => p.TankGuid.HasValue))
{
    <div class="row">
        @foreach (var tank in Model.Where(p => p.TankGuid.HasValue).OrderBy(p => p.TankName))
        {
            @Html.Partial("SensorCard", tank)
        }
    </div>
}
else
{
    <span>Не найдено ни одного топливного бака</span>
}

@*
    <script src="/npm/@@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        var actualValues = @Html.Raw(@actualValues);
        const connection = new signalR.HubConnectionBuilder().withUrl('/broadcast').build();

        const container = $('.container tbody');

        connection.on('sensorupdate', function (data, date) {
            data.forEach(function (item) {
                if (actualValues[item.sensorGuid] == item.sensorValueId) {
                    container.find('tr[data-sensorguid="' + item.sensorGuid + '"]:first').next().find('td:first').html(date);
                } else {
                    actualValues[item.sensorGuid] = item.sensorValueId;

                    var html = '<tr data-sensorguid="' + item.sensorGuid + '"><td>' +
                        date + '</td><td>' +
                        item.date + '</td><td>' +
                        item.eventDate + '</td><td>' +
                        item.value + '</td></tr>';

                    container.find('tr[data-sensorguid="' + item.sensorGuid + '"]:first').after(html);

                    var rowCount = container.find('tr[data-sensorguid="' + item.sensorGuid + '"]').length;
                    if (rowCount == 5) {
                        container.find('tr[data-sensorguid="' + item.sensorGuid + '"]:last').remove();
                    }
                }
            });
        });

        connection.start();
    </script>
*@