@model IEnumerable<ActualSensorValue>
@{
    var pointName = Model.First().PointName;
    ViewBag.Title = pointName;

    var hasError = Model.Any(p => p.IsError);
    var hasWarning = Model.Any(p => p.IsWarning);

    var listenSensors = Model.SelectMany(t =>
    {
        if (t.TankGuid.HasValue && t.DualMode == true)
        {
            return new[]
            {
                new
                {
                    guid = t.MainSensorGuid,
                    updateDate = t.MainSensorLastDate,
                    warningDate = t.MainSensorWarningDateTicks,
                    isSecond = 0
                },
                new
                {
                    guid = t.SecondSensorGuid,
                    updateDate = t.SecondSensorLastDate,
                    warningDate = t.SecondSensorWarningDateTicks,
                    isSecond = 1
                }
                            };
        }
        else
        {
            return new[]
            {
                new
                {
                    guid = t.MainSensorGuid,
                    updateDate = t.MainSensorLastDate,
                    warningDate = t.MainSensorWarningDateTicks,
                    isSecond = -1
                }
                            };
        }
    }).Where(p => p.guid != null).ToDictionary(p => p.guid, p => p);
}

@section AdditionalHeader
{
    @Html.ActionLink("назад к всем объектам", "All", "Point", null, new { @class = "footer-link pull-right additional-header-link" })
}

<div class="t-error-message callout callout-danger @if(!hasError){<text>hidden</text>}">
    <h4>Внимание!</h4>
    <p>Данные с некоторых датчиков никогда не поступали. Проверьте правильность настроек.</p>
</div>
<div class="t-warning-message callout callout-warning @if(!hasWarning){<text>hidden</text>}">
    <h4>Внимание!</h4>
    <p>Данные с некоторых датчиков не поступают больше часа. Проверьте правильность настроек и исправность системы.</p>
</div>

@if (Model.Any(p => p.TankGuid.HasValue))
{
    <div class="row">
        @foreach (var tank in Model.Where(p => p.TankGuid.HasValue).OrderBy(p => p.TankName))
        {
            @Html.Partial("SensorCard", tank)
        }
    </div>
    <script src="/npm/@@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const listenSensors = @Html.Raw(JsonSerializer.Serialize(listenSensors));
        const connection = new signalR.HubConnectionBuilder().withUrl('/broadcast').build();

        var errorBlock = $('.t-error-message');
        var warningBlock = $('.t-warning-message');

        connection.on('sensorupdate', sensorUpdate);

        connection.start();
    </script>

}
else
{
    <span>Не найдено ни одного резервуара</span>
}