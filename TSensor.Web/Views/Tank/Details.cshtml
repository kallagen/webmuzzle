@model TankDetailsViewModel
@{
    ViewBag.Title = $"Резервуар {Model.TankName} {Model.ProductName}";

    var exportDateStart = DateTime.Now.AddDays(-1);
    var exportDateEnd = DateTime.Now;

    var values = new[] { Model.MainValue, Model.SecondValue }.Where(p => p != null);
    var listenSensors = values.Select(p => new { guid = p.SensorGuid, updateDate = p.InsertDate });

    var mainSensorGuid = Model.MainValue?.SensorGuid;
    var secondSensorGuid = Model.SecondValue?.SensorGuid;

    void ValueRow(string sysname, string label, object mainValue, object secondValue)
    {
        <tr>
            <td>@label</td>
            <td class="@sysname" data-sensorGuid="@mainSensorGuid">@mainValue?.ToString()?.Replace(",", ".")</td>
            @if (Model.DualMode)
            {
                <td data-sensorGuid="@secondSensorGuid">@secondValue?.ToString()?.Replace(",", ".")</td>
            }
        </tr>
    }
}

<div class="row">
    <div class="col-md-3">
        @using (Html.BeginForm("Export", "Tank", FormMethod.Post, new { autocomplete = "off" }))
        {
            @Html.Hidden("tankGuid", Model.TankGuid)
            <div class="box box-solid">
                <div class="box-header">
                    <h4>Экспорт данных с датчиков</h4>
                </div>
                <div class="box-body">
                    <div class="form-group">
                        <label for="ExportDateStart">Дата с</label>
                        @Html.TextBox("exportDateStart", exportDateStart, new { @class = "form-control" })
                    </div>
                    <div class="form-group">
                        <label for="ExportDateEnd">Дата по</label>
                        @Html.TextBox("exportDateEnd", exportDateEnd, new { @class = "form-control" })
                    </div>
                </div>
                <div class="box-footer">
                    <button type="submit" class="btn bg-blue">Выгрузить значения</button>
                </div>
            </div>
        }
    </div>
    <div class="col-md-9">
        <div class="box box-solid">
            <div class="box-body table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Название параметра</th>
                            <th>Значение датчика</th>
                            @if (Model.DualMode)
                            {
                                <th>Значение дополнительного датчика</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            ValueRow("izkNumber", "Адрес ИЗК", Model.MainValue?.izkNumber, Model.SecondValue?.izkNumber);
                            ValueRow("banderolType", "Тип посылки", Model.MainValue?.banderolType, Model.SecondValue?.banderolType);
                            ValueRow("sensorSerial", "Адрес датчика", Model.MainValue?.sensorSerial, Model.SecondValue?.sensorSerial);
                            ValueRow("sensorChannel", "Номер канала", Model.MainValue?.sensorChannel, Model.SecondValue?.sensorChannel);
                            ValueRow("sensorFirmwareVersionAndReserv", "версия ПО датчика", Model.MainValue?.sensorFirmwareVersionAndReserv, Model.SecondValue?.sensorFirmwareVersionAndReserv);
                            ValueRow("alarma", "Бит сигнализации", Model.MainValue?.alarma, Model.SecondValue?.alarma);
                            ValueRow("environmentLevel", "Уровень, мм", Model.MainValue?.environmentLevel, Model.SecondValue?.environmentLevel);
                            ValueRow("pressureFilter", "Давление фильтр, атм", Model.MainValue?.pressureFilter, Model.SecondValue?.pressureFilter);
                            ValueRow("pressureMeasuring", "Давление измер, атм", Model.MainValue?.pressureMeasuring, Model.SecondValue?.pressureMeasuring);
                            ValueRow("levelInPercent", "Объем в процентах, %", Model.MainValue?.levelInPercent, Model.SecondValue?.levelInPercent);
                            ValueRow("environmentVolume", "Объем, м3", Model.MainValue?.environmentVolume, Model.SecondValue?.environmentVolume);
                            ValueRow("liquidEnvironmentLevel", "Масса жидкости, т", Model.MainValue?.liquidEnvironmentLevel, Model.SecondValue?.liquidEnvironmentLevel);
                            ValueRow("steamMass", "Масса пара, т", Model.MainValue?.steamMass, Model.SecondValue?.steamMass);
                            ValueRow("liquidDensity", "Плотность жидкости, кг/м2", Model.MainValue?.liquidDensity, Model.SecondValue?.liquidDensity);
                            ValueRow("steamDensity", "Плотность пара, кг/м2", Model.MainValue?.steamDensity, Model.SecondValue?.steamDensity);
                            ValueRow("dielectricPermeability", "Диэлектрическая проницаемость жидкости", Model.MainValue?.dielectricPermeability, Model.SecondValue?.dielectricPermeability);
                            ValueRow("dielectricPermeability2", "Диэлектрическая проницаемость пара", Model.MainValue?.dielectricPermeability2, Model.SecondValue?.dielectricPermeability2);
                            ValueRow("t1", "Температура нижнего датчика?, °C", Model.MainValue?.t1, Model.SecondValue?.t1);
                            ValueRow("t2", "Температура, °C", Model.MainValue?.t2, Model.SecondValue?.t2);
                            ValueRow("t3", "Температура, °C", Model.MainValue?.t3, Model.SecondValue?.t3);
                            ValueRow("t4", "Температура, °C", Model.MainValue?.t4, Model.SecondValue?.t4);
                            ValueRow("t5", "Температура, °C", Model.MainValue?.t5, Model.SecondValue?.t5);
                            ValueRow("t6", "Температура верхнего датчика?, °C", Model.MainValue?.t6, Model.SecondValue?.t6);
                            ValueRow("plateTemp", "Температура платы, °C", Model.MainValue?.plateTemp, Model.SecondValue?.plateTemp);
                            ValueRow("period", "Период платы", Model.MainValue?.period, Model.SecondValue?.period);
                            ValueRow("environmentComposition", "Состав среды, %", Model.MainValue?.environmentComposition, Model.SecondValue?.environmentComposition);
                            ValueRow("cs1", "Измеренная емкость платы, Пф", Model.MainValue?.cs1, Model.SecondValue?.cs1);
                            ValueRow("crc", "Контрольная сумма", Model.MainValue?.crc, Model.SecondValue?.crc);
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="/npm/@@microsoft/signalr/dist/browser/signalr.min.js"></script>
<script>
    new DatePicker('exportDateStart', {
        allowTime: true
    });
    new DatePicker('exportDateEnd', {
        allowTime: true
    });

    @if (listenSensors.Any())
    {
        <text>
            const listenSensors = @Html.Raw(JsonSerializer.Serialize(listenSensors));
            const connection = new signalR.HubConnectionBuilder().withUrl('/broadcast').build();

            connection.on('sensorupdate', tankSensorUpdate);
            connection.start();
        </text>
    }
</script>